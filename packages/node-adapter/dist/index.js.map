{"version":3,"file":"index.js","sources":["../index.ts"],"sourcesContent":["import zlib from 'zlib';\nimport glob from 'tiny-glob';\nimport esbuild from 'esbuild';\n\nimport { join, resolve } from 'path';\nimport { pipeline } from 'stream';\nimport { fileURLToPath } from 'url';\nimport { promisify } from 'util';\nimport {\n\tcreateReadStream,\n\tcreateWriteStream,\n\texistsSync,\n\treadFileSync,\n\tstatSync,\n\twriteFileSync\n} from 'fs';\n\nimport type { Adapter } from '@sveltejs/kit';\nimport type { BuildOptions } from 'esbuild';\n\ninterface Env {\n\tpath?: string;\n\thost?: string;\n\tport?: string;\n}\n\ninterface Config {\n\tentryPoint?: string;\n\tout?: string;\n\tprecompress?: boolean;\n\tenv?: Env;\n\tesbuild?: (conf: BuildOptions) => Promise<BuildOptions>;\n}\n\nconst pipe = promisify(pipeline);\n\nexport default function ({\n\tentryPoint = '.svelte-kit/node/index.js',\n\tout = 'build',\n\tprecompress,\n\tenv: { path: path_env = 'SOCKET_PATH', host: host_env = 'HOST', port: port_env = 'PORT' } = {},\n\tesbuild: esbuild_config\n}: Config = {}): Adapter {\n\treturn {\n\t\tname: '@sveltejs/adapter-node-kit-image',\n\n\t\tasync adapt({ utils, config }) {\n\t\t\tutils.rimraf(out);\n\n\t\t\tutils.log.minor('Copying assets');\n\t\t\tconst static_directory = join(out, 'assets');\n\t\t\tutils.copy_client_files(static_directory);\n\t\t\tutils.copy_static_files(static_directory);\n\n\t\t\tif (precompress) {\n\t\t\t\tutils.log.minor('Compressing assets');\n\t\t\t\tawait compress(static_directory);\n\t\t\t}\n\n\t\t\tutils.log.minor('Building SvelteKit middleware');\n\t\t\tconst files = fileURLToPath(new URL('./files', import.meta.url));\n\t\t\tutils.copy(files, '.svelte-kit/node');\n\t\t\twriteFileSync(\n\t\t\t\t'.svelte-kit/node/env.js',\n\t\t\t\t`export const path = process.env[${JSON.stringify(\n\t\t\t\t\tpath_env\n\t\t\t\t)}] || false;\\nexport const host = process.env[${JSON.stringify(\n\t\t\t\t\thost_env\n\t\t\t\t)}] || '0.0.0.0';\\nexport const port = process.env[${JSON.stringify(\n\t\t\t\t\tport_env\n\t\t\t\t)}] || (!path && 3000);`\n\t\t\t);\n\n\t\t\tconst defaultOptions: BuildOptions = {\n\t\t\t\tentryPoints: ['.svelte-kit/node/middlewares.js'],\n\t\t\t\toutfile: join(out, 'middlewares.js'),\n\t\t\t\tbundle: true,\n\t\t\t\texternal: Object.keys(\n\t\t\t\t\tJSON.parse(readFileSync('package.json', 'utf8')).dependencies || {}\n\t\t\t\t),\n\t\t\t\tformat: 'esm',\n\t\t\t\tplatform: 'node',\n\t\t\t\ttarget: 'node14',\n\t\t\t\tinject: [join(files, 'shims.js')],\n\t\t\t\tdefine: {\n\t\t\t\t\tAPP_DIR: `\"/${config.kit.appDir}/\"`\n\t\t\t\t}\n\t\t\t};\n\t\t\tconst build_options = esbuild_config\n\t\t\t\t? await esbuild_config(defaultOptions)\n\t\t\t\t: defaultOptions;\n\t\t\tawait esbuild.build(build_options);\n\n\t\t\tutils.log.minor('Building SvelteKit server');\n\n\t\t\tconst default_options_ref_server: BuildOptions = {\n\t\t\t\tentryPoints: [entryPoint],\n\t\t\t\toutfile: join(out, 'index.js'),\n\t\t\t\tbundle: true,\n\t\t\t\tformat: 'esm',\n\t\t\t\tplatform: 'node',\n\t\t\t\ttarget: 'node14',\n\t\t\t\t// external exclude workaround, see https://github.com/evanw/esbuild/issues/514\n\t\t\t\tplugins: [\n\t\t\t\t\t{\n\t\t\t\t\t\tname: 'fix-middlewares-exclude',\n\t\t\t\t\t\tsetup(build) {\n\t\t\t\t\t\t\t// Match an import of \"middlewares.js\" and mark it as external\n\t\t\t\t\t\t\tconst internal_middlewares_path = resolve(\n\t\t\t\t\t\t\t\t'.svelte-kit/node/middlewares.js'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tconst build_middlewares_path = resolve(out, 'middlewares.js');\n\t\t\t\t\t\t\tbuild.onResolve(\n\t\t\t\t\t\t\t\t{ filter: /\\/middlewares\\.js$/ },\n\t\t\t\t\t\t\t\t({ path, resolveDir }) => {\n\t\t\t\t\t\t\t\t\tconst resolved = resolve(resolveDir, path);\n\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\tresolved === internal_middlewares_path ||\n\t\t\t\t\t\t\t\t\t\tresolved === build_middlewares_path\n\t\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t\t\tpath: './middlewares.js',\n\t\t\t\t\t\t\t\t\t\t\texternal: true\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t};\n\t\t\tconst build_options_ref_server = esbuild_config\n\t\t\t\t? await esbuild_config(default_options_ref_server)\n\t\t\t\t: default_options_ref_server;\n\t\t\tawait esbuild.build(build_options_ref_server);\n\n\t\t\tutils.log.minor('Prerendering static pages');\n\t\t\tawait utils.prerender({\n\t\t\t\tdest: `${out}/prerendered`\n\t\t\t});\n\n\t\t\tif (precompress && existsSync(`${out}/prerendered`)) {\n\t\t\t\tutils.log.minor('Compressing prerendered pages');\n\t\t\t\tawait compress(`${out}/prerendered`);\n\t\t\t}\n\t\t}\n\t};\n}\n\nasync function compress(directory: string) {\n\tconst files = await glob('**/*.{html,js,json,css,svg,xml}', {\n\t\tcwd: directory,\n\t\tdot: true,\n\t\tabsolute: true,\n\t\tfilesOnly: true\n\t});\n\n\tawait Promise.all(\n\t\tfiles.map((file) => Promise.all([compress_file(file, 'gz'), compress_file(file, 'br')]))\n\t);\n}\n\nasync function compress_file(file: string, format: 'gz' | 'br' = 'gz') {\n\tconst compress =\n\t\tformat === 'br'\n\t\t\t? zlib.createBrotliCompress({\n\t\t\t\t\tparams: {\n\t\t\t\t\t\t[zlib.constants.BROTLI_PARAM_MODE]: zlib.constants.BROTLI_MODE_TEXT,\n\t\t\t\t\t\t[zlib.constants.BROTLI_PARAM_QUALITY]: zlib.constants.BROTLI_MAX_QUALITY,\n\t\t\t\t\t\t[zlib.constants.BROTLI_PARAM_SIZE_HINT]: statSync(file).size\n\t\t\t\t\t}\n\t\t\t  })\n\t\t\t: zlib.createGzip({ level: zlib.constants.Z_BEST_COMPRESSION });\n\n\tconst source = createReadStream(file);\n\tconst destination = createWriteStream(`${file}.${format}`);\n\n\tawait pipe(source, compress, destination);\n}\n"],"names":[],"mappings":"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"}